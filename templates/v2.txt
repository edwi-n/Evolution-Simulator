<!-- 1000 x 1000 -->


<!DOCTYPE html>     
<html>
<head>
          <style>
                    body{
                              background-color: grey;
                              color: white
                    }
          </style>
</head>

<body>
<h1 id="title">Evolution Simulator</h1>
          <div id="simulation-main">
                    <div id="simulation-info"></div>
                    <canvas id="simulation-grid" width="1000" height="1000"></canvas>
                    <!-- <div id="simulation-grid"></div> -->
                    <div id="simulation-progress"></div>
                    <div id="selected-organism-info"></div>
          </div>
</div>
</body>
</html>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
          var data = JSON.parse('{{data | tojson | safe}}')
          const canvas = document.getElementById("simulation-grid")
          const ctx = canvas.getContext("2d")
          var iteration = 1
          var j = 0
          ctx.fillStyle = "white"
          ctx.fillRect(0, 0, 1000, 1000)

          chain = fetch("/get").then((response)=>{
                    console.log(iteration)
                    iteration+=1
                                        return response.json()
                              }).then((dat)=>{
                                        data.movement = data.movement.concat(dat.movement)
                                        data.organisms = data.organisms.concat(dat.organisms)
                                        while(j<data.movement.length){
                                                  j+=1;
                                        }
                                        return j
                              })
          for (let i=0; i<100; i++){
                    chain = chain.then((a)=>{
                              iteration+=1
                              return fetch("/get")
                    }).then((response)=>{
                              return response.json();
                    }).then((dat)=>{
                              data.movement = data.movement.concat(dat.movement)
                              data.organisms = data.organisms.concat(dat.organisms)
                              prev = {}
                              newChain = (a) => {
                                        setInterval(function(){
                                        if(data.movement[j][0] == -1){
                                                  ctx.fillRect(0, 0, 1000, 1000)
                                                  j+=1;
                                        }else{
                                                  if(data.movement[j][0] in prev){
                                                            ctx.fillRect(prev[data.movement[j][0]][0]*10, prev[data.movement[j][0]][1]*10, 10, 10)
                                                  }
                                                  ctx.clearRect(data.movement[j][1][1]*10, data.movement[j][1][0]*10, 10, 10)
                                                  prev[data.movement[j][0]] = [data.movement[j][1][1], [data.movement[j][1][0]]]
                                                  document.getElementById("simulation-progress").innerHTML = i
                                                  j += 1
                                        }}, 100);
                              }
                              while(j<data.movement.length){
                                        newChain = newChain.then((a)=>{
                                              setInterval(function(){
                                        if(data.movement[j][0] == -1){
                                                  ctx.fillRect(0, 0, 1000, 1000)
                                                  j+=1;
                                        }else{
                                                  if(data.movement[j][0] in prev){
                                                            ctx.fillRect(prev[data.movement[j][0]][0]*10, prev[data.movement[j][0]][1]*10, 10, 10)
                                                  }
                                                  ctx.clearRect(data.movement[j][1][1]*10, data.movement[j][1][0]*10, 10, 10)
                                                  prev[data.movement[j][0]] = [data.movement[j][1][1], [data.movement[j][1][0]]]
                                                  document.getElementById("simulation-progress").innerHTML = i
                                                  j += 1
                                        }}, 100);  
                                        })
                                        console.log(j)
                                        
                              }
                              return j
                    })
                    console.log(data.movement.length)
          }
          chain.then(()=>{
                    console.log(j);
                    console.log(data)
          })
</script>

<!-- end -->



